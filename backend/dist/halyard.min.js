/**
 * halyard.js v1.3.2
 * Copyright (c) 2019 QlikTech International AB
 * This library is licensed under MIT - See the LICENSE file for full details
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).halyard=t()}(this,function(){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function t(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&r(e,t)}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function r(e,t){return(r=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function o(e,t,n){return(o="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=s(e)););return e}(e,t);if(i){var a=Object.getOwnPropertyDescriptor(i,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function c(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function l(e){return e.replace(/"/g,'""')}function h(e){return-1<["time","timestamp","date","interval"].indexOf((e=e||"").toLowerCase())}function m(e){return e.name||e.src}var d=function(){function n(e,t){u(this,n),this.path=e,this.connectionType=t,this.fileExtension=""}return a(n,[{key:"getFileExtension",value:function(){return this.fileExtension}},{key:"getConnectionType",value:function(){return this.connectionType}},{key:"getQixConnectionObject",value:function(){return{qName:this.getName(),qConnectionString:this.path,qType:this.getConnectionType()}}},{key:"getName",value:function(){return this.name||(this.name="xxxxx-8xxxx-yxxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),this.name}},{key:"getLibStatement",value:function(){return"lib://".concat(this.getName())}},{key:"getScript",value:function(){return"FROM [".concat(this.getLibStatement(),"]")}}]),n}(),p={File:function(e){function c(e){var t,n,i,a,r,o;return u(this,c),(t=f(this,s(c).call(this,(i=(n=e).match(/^(.*)(\\.*\..*$|\\.*)$/))?i[1]:(i=n.match(/^(.*)(\/.*\..*$|\/.*)$/))&&i[1],"folder"))).fileName=(r=(a=e).match(/^.*\\(.*\..*|.*)$/))?r[1]:(r=a.match(/^.*\/(.*\..*|.*)$/))&&r[1],t.fileExtension=(o=e.match(/^.*\.(.*)$/))&&o[1]||"txt",t}return t(c,d),a(c,[{key:"getLibStatement",value:function(){return"".concat(o(s(c.prototype),"getLibStatement",this).call(this),"/").concat(this.fileName)}}]),c}(),Web:function(e){function a(e,t){var n;u(this,a),n=f(this,s(a).call(this,e,"internet"));var i=e.match(/^https?:\/\/.*\/.*\.(\w*)\?.*$/)||e.match(/^https?:\/\/.*\/.*\.(\w*)$/);return n.fileExtension=t||i&&i[1]||"html",n}return t(a,d),a}(),Inline:function(e){function n(e){var t;return u(this,n),(t=f(this,s(n).call(this))).data=e,t.fileExtension="txt",t}return t(n,d),a(n,[{key:"getScript",value:function(){return'INLINE "\n'.concat(l(this.data),'\n"')}},{key:"getLibStatement",value:function(){}},{key:"getQixConnectionObject",value:function(){}}]),n}()};function y(e,t){return e&&"string"==typeof e&&(-1<e.indexOf(t)||-1<e.indexOf("\n"))?'"'.concat(e.replace(/"/g,'""').replace(/\n/g," "),'"'):e}var g=new(function(){function e(){u(this,e),this.connectionsRegistry=[]}return a(e,[{key:"addConnection",value:function(e,t){this.connectionsRegistry.push({matchingFn:e,connection:t})}},{key:"findMatch",value:function(e){for(var t=0;t<this.connectionsRegistry.length;t+=1)if(this.connectionsRegistry[t].matchingFn(e))return this.connectionsRegistry[t].connection(e);return e}}]),e}());function v(e){return-1<["utf8","unicode","ansi","oem","mac"].indexOf(e)&&e||"NaN"!==Number(e).toString()&&"codepage is ".concat(e)}g.addConnection(function(e){return"string"==typeof e&&e.match(/^https?:\/\/(.*)$/g)},function(e){return new p.Web(e)}),g.addConnection(function(e){return"string"==typeof e&&e.match(/^.*\.(.*)$/g)},function(e){return new p.File(e)}),g.addConnection(function(e){return e instanceof Array&&!!((t=e)instanceof Array&&t[0]&&"object"===n(t[0]));var t},function(e){return new p.Inline(function(e){e instanceof Array==0&&(e=[e]);var t="",n=Object.keys(e[0]);t="".concat(t+n.map(function(e){return y(e,",")}).join(","),"\n");for(var i=[],a=0;a<e.length;a+=1){i=[];for(var r=0;r<n.length;r+=1)i.push(y(e[a][n[r]],","));t="".concat(t+i.join(","),"\n")}return t=t.slice(0,-"\n".length)}(e))}),g.addConnection(function(e){return"string"==typeof e},function(e){return new p.Inline(e)});var q=function(){function n(e,t){u(this,n),this.connection=g.findMatch(e),"string"==typeof(t=t||{})?(this.name=t,t={}):(this.name=t.name,this.fields=t.fields,this.prefix=t.prefix,t.section&&(this.section=t.section)),this.options=t}return a(n,[{key:"getFields",value:function(){return this.fields}},{key:"getFieldList",value:function(){return this.fields?this.fields.map(function(e){var t='"'.concat(l(e.src||""),'"');if(h(e.type)){var n=e.type.toUpperCase();e.inputFormat&&(t="".concat(n,"#(").concat(t,", '").concat(e.inputFormat,"')")),t=e.displayFormat?"".concat(n,"(").concat(t,", '").concat(e.displayFormat,"')"):"".concat(n,"(").concat(t,")")}if(e.expr&&(t=e.expr),!e.name&&!e.src)throw new Error("A name or src needs to specified on the field: ".concat(JSON.stringify(e)));return"".concat("  "+t,' AS "').concat(l(e.name||e.src),'"')}).join(",\n"):"*"}},{key:"isProceedingLoad",value:function(){return this.connection instanceof n}},{key:"getPrefix",value:function(){return this.prefix?"".concat(this.prefix,"\n"):""}},{key:"getScript",value:function(){return this.isProceedingLoad()?"".concat(this.getPrefix(),"LOAD\n").concat(this.getFieldList(),";\n").concat(this.connection.getScript()):(this.connection.getFileExtension&&(this.options.fileExtension=this.connection.getFileExtension()),"".concat(this.getPrefix(),"LOAD\n").concat(this.getFieldList(),"\n").concat(this.connection.getScript()).concat(function(e){e||(e={});var t=[];if(e.fileExtension){var n=e.fileExtension;"xlsx"===n&&(n="ooxml"),"csv"===n&&(n="txt"),"htm"===n&&(n="html"),t.push(n)}(e.headerRowNr||0===e.headerRowNr)&&(t.push("header is ".concat(e.headerRowNr," lines")),t.push("embedded labels")),e.delimiter&&t.push("delimiter is '".concat(e.delimiter,"'")),e.characterSet&&v(e.characterSet)&&t.push(v(e.characterSet)),e.srcTable&&t.push('table is "'.concat(l(e.srcTable),'"')),e.noLabels&&t.push("no labels");var i="";return 0<t.length&&(i="\n(".concat(t.join(", "),")")),i}(this.options),";"))}},{key:"getName",value:function(){return this.name||""}},{key:"getSection",value:function(){return this.section}},{key:"getConnection",value:function(){return this.connection}}]),n}(),D={qTypes:{timestamp:"TS",date:"D",time:"T",interval:"IV"},qDimensionType:{timestamp:"T",text:"D",numeric:"N"}},x=",";function T(e){return e.qDimensionType===D.qDimensionType.text?"text":(t=e).qDimensionType===D.qDimensionType.numeric&&0===t.qTags.length?"mixed":(n=e).qDimensionType===D.qDimensionType.timestamp||n.qDimensionType===D.qDimensionType.numeric&&n.qNumFormat.qType===D.qTypes.timestamp?"timestamp":(i=e).qDimensionType===D.qDimensionType.numeric&&i.qNumFormat.qType===D.qTypes.time?"time":(a=e).qDimensionType===D.qDimensionType.numeric&&a.qNumFormat.qType===D.qTypes.date?"date":(r=e).qDimensionType===D.qDimensionType.numeric&&r.qNumFormat.qType===D.qTypes.interval?"interval":"num";var t,n,i,a,r}function S(e,t){return-1<e.indexOf(t)||-1<e.indexOf("\n")?"'".concat(e.replace(/'/g,"''").replace(/\n/g," "),"'"):e}function b(e,t){return"measure"===(n=t).type||"dimension"===n.type&&(i=n.dimensionType,-1<["timestamp","interval","time","date","num"].indexOf((i=i||"").toLowerCase()))?e.qNum:S(e.qText,x);var n,i}var k=function(){function n(e,t){u(this,n),this.items=[],this.fields=[],this.hyperCubeLayout=this.validateHyperCubeLayout(e),"string"==typeof(t=t||{})?(this.name=t,t={}):(this.name=t.name,t.section&&(this.section=t.section)),this.parseHyperCubeLayout(t),this.options=t}return a(n,[{key:"validateHyperCubeLayout",value:function(e){if(!e)throw new Error("Hyper cube layout is undefined");if(!e.qDimensionInfo)throw new Error("qDimensionInfo is undefined");if(!e.qMeasureInfo)throw new Error("qMeasureInfo is undefined");if("P"===e.qMode)throw new Error("Cannot add hyper cube in pivot mode, qMode:P(DATA_MODE_PIVOT) is not supported");if("K"===e.qMode)throw new Error("Cannot add hyper cube in stacked mode, qMode:K(DATA_MODE_PIVOT_STACK) is not supported");if("S"===e.qMode)return this.validateDataPages(e.qDataPages),this.validateDataPagesCoverage(e.qDataPages,e),e;throw new Error("HyperCubeLayout is not valid")}},{key:"validateDataPages",value:function(e){if(!e)throw new Error("qDataPages are undefined");if(e[0].qArea&&0<e[0].qArea.qTop)throw new Error("qDataPages first page should start at qTop: 0.")}},{key:"validateDataPagesCoverage",value:function(e,t){var n=this,i=0;if(e.forEach(function(e){n.validateQMatrix(e),n.validateQArea(e,t,i),i+=e.qArea.qHeight},this),t.qSize.qcy!==i)throw new Error("qDataPages are missing pages.")}},{key:"validateQMatrix",value:function(e){if(!e.qMatrix)throw new Error("qMatrix of qDataPages are undefined");if(0===e.qMatrix.length)throw new Error("qDataPages are empty")}},{key:"validateQArea",value:function(e,t,n){if(!e.qArea)throw new Error("qArea of qDataPages are undefined");if(0<e.qArea.qLeft)throw new Error("qDataPages have data pages that's not of full qWidth.");if(e.qArea.qWidth<t.qSize.qcx)throw new Error("qDataPages have data pages that's not of full qWidth.");if(e.qArea.qTop<n)throw new Error("qDataPages have overlapping data pages.");if(e.qArea.qTop>n)throw new Error("qDataPages are missing pages.")}},{key:"parseHyperCubeLayout",value:function(){var t=this;t.fields=t.getFieldsFromHyperCubeLayout(),t.data=t.getDataFromHyperCubeLayout();var e="".concat(t.fields.map(function(e){return e.name}).join(","),"\n").concat(this.data),n=!1;t.fields.forEach(function(e){e.isDual&&(n=!0,t.items.push(t.getMapTableForDualField(e)))});var i={name:t.name,fields:t.getFieldsDefinition(t.fields)};t.section&&!n&&(i.section=t.section),t.items.push(new q(e,i))}},{key:"getFieldsDefinition",value:function(e){return e.map(function(e){var t={name:e.name};return h(e.dimensionType)&&(t.type=e.dimensionType,t.displayFormat=e.displayFormat),e.isDual?t.expr="Dual(ApplyMap('MapDual__".concat(e.name,"', \"").concat(e.name,'"), "').concat(e.name,'")'):t.src=e.name,t})}},{key:"mapDualFieldQMatrix",value:function(e,n){return e.map(function(e){return t=e[n.index],"".concat(t.qNum).concat(x).concat(S(t.qText,x));var t}).filter(function(e,t,n){return n.indexOf(e)===t})}},{key:"getMapTableForDualField",value:function(e){var t,n=this.hyperCubeLayout.qDataPages.reduce(function(e,t){return[].concat(c(e),c(t.qMatrix))},[]),i=this.mapDualFieldQMatrix(n,e),a="".concat((t=e).name).concat(x).concat(t.name,"_qText}"),r="".concat(a,"\n").concat(i.join("\n")),o={name:"MapDual__".concat(e.name),prefix:"Mapping"};return this.section&&0===this.items.length&&(o.section=this.section),new q(r,o)}},{key:"getDataFromHyperCubeLayout",value:function(){var r=this;return r.hyperCubeLayout.qDataPages.map(function(e){return e.qMatrix.map(function(e){return e.map(function(e,t){var n,i,a=r.fields[t];return a.isDual||(n=e,"dimension"!==(i=a).type||"num"!==i.dimensionType||n.qText===Number(n.qNum).toString())||(a.isDual=!0),b(e,a)}).join(",")}).join("\n")}).join("\n")}},{key:"getFieldsFromHyperCubeLayout",value:function(){for(var e=this,t=[],n=0;n<e.hyperCubeLayout.qDimensionInfo.length;n+=1)t.push({type:"dimension",dimensionType:T(e.hyperCubeLayout.qDimensionInfo[n]),name:e.hyperCubeLayout.qDimensionInfo[n].qFallbackTitle,displayFormat:e.hyperCubeLayout.qDimensionInfo[n].qNumFormat.qFmt,index:n});for(var i=0;i<e.hyperCubeLayout.qMeasureInfo.length;i+=1)t.push({type:"measure",name:e.hyperCubeLayout.qMeasureInfo[i].qFallbackTitle,index:e.hyperCubeLayout.qDimensionInfo.length+i});return t}},{key:"getItems",value:function(){return this.items}}]),n}(),$=function(){function t(e){u(this,t),this.defaultSetStatements=e}return a(t,[{key:"getScript",value:function(){var t=this;return Object.keys(this.defaultSetStatements).map(function(e){return"SET ".concat(e,"='").concat(Array.isArray(t.defaultSetStatements[e])?t.defaultSetStatements[e].join(";"):t.defaultSetStatements[e],"';")}).join("\n")}},{key:"getName",value:function(){return""}}]),t}(),w=function(){function t(e){u(this,t),this.getFieldFn=e.fieldMatchFunction,this.name=e.name,this.fieldTag=e.fieldTag,this.derivedFieldDefinition=e.derivedFieldDefinition}return a(t,[{key:"getScript",value:function(){var e=this.getFieldFn()||[];if(0<e.length)return this.getDefinition(e.map(m))}},{key:"getDefinition",value:function(e){return'"'.concat(l(this.name),"\":\nDECLARE FIELD DEFINITION Tagged ('$").concat(this.fieldTag,"')\nFIELDS\n").concat(this.derivedFieldDefinition,"\nDERIVE FIELDS FROM FIELDS [").concat(e.join(", "),'] USING "').concat(l(this.name),'";')}}]),t}(),F="Dual(Year($1), YearStart($1)) AS [Year] Tagged ('$axis', '$year'),\n  Dual('Q'&Num(Ceil(Num(Month($1))/3)),Num(Ceil(NUM(Month($1))/3),00)) AS [Quarter] Tagged ('$quarter', '$cyclic'),\n  Dual(Year($1)&'-Q'&Num(Ceil(Num(Month($1))/3)),QuarterStart($1)) AS [YearQuarter] Tagged ('$yearquarter', '$qualified'),\n  Dual('Q'&Num(Ceil(Num(Month($1))/3)),QuarterStart($1)) AS [_YearQuarter] Tagged ('$yearquarter', '$hidden', '$simplified'),\n  Month($1) AS [Month] Tagged ('$month', '$cyclic'),\n  Dual(Year($1)&'-'&Month($1), monthstart($1)) AS [YearMonth] Tagged ('$axis', '$yearmonth', '$qualified'),\n  Dual(Month($1), monthstart($1)) AS [_YearMonth] Tagged ('$axis', '$yearmonth', '$simplified', '$hidden'),\n  Dual('W'&Num(Week($1),00), Num(Week($1),00)) AS [Week] Tagged ('$weeknumber', '$cyclic'),\n  Date(Floor($1)) AS [Date] Tagged ('$axis', '$date', '$qualified'),\n  Date(Floor($1), 'D') AS [_Date] Tagged ('$axis', '$date', '$hidden', '$simplified'),\n  If (DayNumberOfYear($1) <= DayNumberOfYear(Today()), 1, 0) AS [InYTD] ,\nYear(Today())-Year($1) AS [YearsAgo] ,\n  If (DayNumberOfQuarter($1) <= DayNumberOfQuarter(Today()),1,0) AS [InQTD] ,\n4*Year(Today())+Ceil(Month(Today())/3)-4*Year($1)-Ceil(Month($1)/3) AS [QuartersAgo] ,\nCeil(Month(Today())/3)-Ceil(Month($1)/3) AS [QuarterRelNo] ,\n  If(Day($1)<=Day(Today()),1,0) AS [InMTD] ,\n12*Year(Today())+Month(Today())-12*Year($1)-Month($1) AS [MonthsAgo] ,\nMonth(Today())-Month($1) AS [MonthRelNo] ,\n  If(WeekDay($1)<=WeekDay(Today()),1,0) AS [InWTD] ,\n(WeekStart(Today())-WeekStart($1))/7 AS [WeeksAgo] ,\nWeek(Today())-Week($1) AS [WeekRelNo];";var e=function(){function n(){var e,t=this;u(this,n),this.defaultSetStatements={},this.items=[],this.addItem(new $(this.defaultSetStatements)),this.lastItems=[(e=function(e){return t.getFields(e)},new w({name:"autoCalendar",fieldTag:"date",derivedFieldDefinition:F,fieldMatchFunction:function(){return e(function(e){return e.calendarTemplate})}}))]}return a(n,[{key:"getConnections",value:function(){return this.items.filter(function(e){return e.getConnection}).map(function(e){return e.getConnection()})}},{key:"getQixConnections",value:function(){return this.getConnections().map(function(e){return e.getQixConnectionObject()}).filter(function(e){return e})}},{key:"getFields",value:function(t){t=t||function(){return!0};var n=[];return this.items.forEach(function(e){e.getFields&&e.getFields()&&n.push.apply(n,c(e.getFields().filter(t)))}),n}},{key:"setDefaultSetStatements",value:function(t,n){var i=this;Object.keys(t).forEach(function(e){n&&i.defaultSetStatements[e]||(i.defaultSetStatements[e]=t[e])})}},{key:"getItemScript",value:function(e){var t=e.getScript();return e.getName&&e.getName()&&(t=e.section?"///$tab ".concat(l(e.section),'\n"').concat(l(e.getName()),'":\n').concat(t):'"'.concat(l(e.getName()),'":\n').concat(t)),t}},{key:"getAllScriptBlocks",value:function(){return this.items.concat(this.lastItems).filter(function(e){return e.getScript()})}},{key:"getScript",value:function(){var t=this;return this.getAllScriptBlocks().map(function(e){return t.getItemScript(e)}).join("\n\n")}},{key:"addHyperCube",value:function(e,t){var n;n=e instanceof k?e:new k(e,t);for(var i=0;i<n.items.length;i+=1)this.checkIfItemNameExists(n.items[i]);for(var a=0;a<n.items.length;a+=1)this.addItem(n.items[a]);return n}},{key:"addTable",value:function(e,t){var n;return n=e instanceof q?e:new q(e,t),this.addItem(n)}},{key:"checkIfItemNameExists",value:function(t){if(t.getName&&t.getName()&&0<this.items.filter(function(e){return e.getName()===t.getName()}).length)throw new Error("Cannot add another table with the same name.")}},{key:"addItem",value:function(e){return this.checkIfItemNameExists(e),this.items.push(e),e}},{key:"getItemThatGeneratedScriptAt",value:function(e){for(var t=this.getAllScriptBlocks(),n=0,i=0;i<t.length;i+=1){var a=this.getItemScript(t[i]),r=n+"".concat(a).concat("\n\n").length;if(n<=e&&e<=r)return t[i];n=r}}}]),n}();return e.Table=q,e.HyperCube=k,e.Connections=p,"undefined"!=typeof module&&(module.exports=e),e});
//# sourceMappingURL=halyard.min.js.map
