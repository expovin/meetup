{"version":3,"file":"halyard-enigma-mixin.min.js","sources":["../src/enigma-mixin/halyard-enigma-mixin.js","../src/enigma-mixin/utils.js"],"sourcesContent":["import convertQixGetLocalInfo from './utils';\n\nconst CONNECTION_ERROR = 'Connection Error';\nconst LOADING_ERROR = 'Loading Error';\nconst SYNTAX_ERROR = 'Syntax Error';\n/**\n * Create error message\n * @private\n * @param {string} errorType\n * @param {object} qixError\n * @param {(Table|HyperCube)} item\n * @returns {{type: string, message: string, item: object, qixError: string}}\n */\nfunction createErrorMessage(errorType, qixError, item) {\n  return {\n    type: errorType,\n    message: qixError.message || qixError.qErrorString,\n    item,\n    qixError,\n  };\n}\n\nconst halyardMixin = {\n  types: 'Global',\n  init(args) {\n    if (args.config) {\n      args.api.Promise = args.config.Promise;\n    } else {\n      args.api.Promise = args.Promise;\n    }\n  },\n  extend: {\n    /**\n     * Creates a session app based on the model in the halyard instance\n     * @public\n     * @param {Halyard} halyard - A halyard instance\n     * @returns {Promise.<TResult>}\n     */\n    createSessionAppUsingHalyard(halyard) {\n      const that = this;\n      return that.createSessionApp().then(app => that.setScriptAndReloadWithHalyard(app, halyard, false));\n    },\n\n    /**\n     * Creates an app with the model in the halyard instance.\n     * @public\n     * @param {string} appName\n     * @param {Halyard} halyard\n     * @returns {Promise.<TResult>}\n     */\n    createAppUsingHalyard(appName, halyard) {\n      const that = this;\n      return that.createApp(appName).then((app) => {\n        const appId = app.qAppId;\n        return that.openDoc(appId).then(result => that.setScriptAndReloadWithHalyard(result, halyard, true));\n      });\n    },\n\n    /**\n     * Reloads an existing app with the model in the halyard instance. Can also create an app is createIfMissing is set to true.\n     * @public\n     * @param {string} existingAppName\n     * @param {Halyard} halyard\n     * @param {boolean} createIfMissing\n     * @returns {Promise.<TResult>}\n     */\n    reloadAppUsingHalyard(existingAppName, halyard, createIfMissing) {\n      const that = this;\n      return that.openDoc(existingAppName)\n        .catch((error) => {\n          const COULD_NOT_FIND_APP = 1003;\n\n          if (createIfMissing && error.code === COULD_NOT_FIND_APP) {\n            return that.createApp(existingAppName).then(app => that.openDoc(app.qAppId));\n          }\n          return that.Promise.reject(error);\n        })\n        .then(result => that.setScriptAndReloadWithHalyard(result, halyard, true));\n    },\n\n    /**\n     * Use the model in halyard to set the script of an app and save it\n     * @public\n     * @param {object} app\n     * @param {Halyard} halyard\n     * @param {boolean} doSaveAfterReload\n     * @returns {Promise.<TResult>}\n     */\n    setScriptAndReloadWithHalyard(app, halyard, doSaveAfterReload) {\n      const that = this;\n      const deferredConnections = [];\n\n      halyard.getConnections().forEach((connection) => {\n        const qixConnectionObject = connection.getQixConnectionObject();\n        if (qixConnectionObject) {\n          const connectionPromise = app.createConnection(qixConnectionObject)\n            .then(result => result, (err) => {\n              const LOCERR_CONNECTION_ALREADY_EXISTS = 2000;\n\n              // Will not throw error if connection already exists.\n              // The connections guid makes the connections unique and we assumes that it\n              // is the same that was previously created\n              if (!(err.code && err.code === LOCERR_CONNECTION_ALREADY_EXISTS)) {\n                throw createErrorMessage(CONNECTION_ERROR, err, connection);\n              }\n            });\n\n          deferredConnections.push(connectionPromise);\n        }\n      });\n\n      return that.Promise.all(deferredConnections).then(() => app.getLocaleInfo().then((localeInfoResult) => {\n        halyard.setDefaultSetStatements(convertQixGetLocalInfo(localeInfoResult), true);\n        return app.globalApi.configureReload(true, true, false).then(() => app.setScript(halyard.getScript())\n          .then(() => app.doReload().then(() => app.globalApi.getProgress(0).then((progressResult) => {\n            if (progressResult.qErrorData.length !== 0) {\n              return app.checkScriptSyntax().then((syntaxCheckData) => {\n                if (syntaxCheckData.length === 0) {\n                  throw createErrorMessage(LOADING_ERROR, progressResult.qErrorData[0]);\n                } else {\n                  const item = halyard.getItemThatGeneratedScriptAt(syntaxCheckData[0].qTextPos);\n                  throw createErrorMessage(SYNTAX_ERROR, progressResult.qErrorData[0], item);\n                }\n              });\n            }\n\n            if (doSaveAfterReload) {\n              return app.doSave().then(() => app);\n            }\n\n            return app;\n          }))));\n      }));\n    },\n  },\n};\n\n\nconst exposeGlobalApi = {\n  types: 'Doc',\n  init(args) {\n    const getObjectArgs = {\n      handle: -1,\n      id: 'Global',\n      type: 'Global',\n    };\n    if (args.config) {\n      getObjectArgs.genericType = 'Global';\n    } else {\n      getObjectArgs.customType = 'Global';\n      getObjectArgs.delta = true;\n    }\n    args.api.globalApi = args.api.session.getObjectApi(getObjectArgs);\n  },\n};\n\nmodule.exports = [halyardMixin, exposeGlobalApi];\n","/**\n * @public\n * @param {{qThousandSep: string, qDecimalSep: string, qMoneyThousandSep: string, qMoneyDecimalSep: string, qMoneyFmt: string,\n * qTimeFmt: string, qDateFmt: string, qTimestampFmt: string, qFirstWeekDay: string, qReferenceDay: string,\n * qFirstMonthOfYear: string, qCollation: string, qMonthNames: string,\n * qLongMonthNames: string, qDayNames: string, qLongDayNames: string }} localInfoData\n * @returns {{ThousandSep: string, DecimalSep: string, MoneyThousandSep: string, MoneyDecimalSep: string,\n * MoneyFormat: string, TimeFormat: string, DateFormat: string, TimestampFormat: string, FirstWeekDay: string,\n * ReferenceDay: string, FirstMonthOfYear: string, CollationLocale: string, MonthNames: string, LongMonthNames: string,\n * DayNames: string, LongDayNames: string}}\n */\nexport default function convertQixGetLocalInfo(localInfoData) {\n  return {\n    ThousandSep: localInfoData.qThousandSep,\n    DecimalSep: localInfoData.qDecimalSep,\n    MoneyThousandSep: localInfoData.qMoneyThousandSep,\n    MoneyDecimalSep: localInfoData.qMoneyDecimalSep,\n    MoneyFormat: localInfoData.qMoneyFmt,\n    TimeFormat: localInfoData.qTimeFmt,\n    DateFormat: localInfoData.qDateFmt,\n    TimestampFormat: localInfoData.qTimestampFmt,\n    FirstWeekDay: localInfoData.qFirstWeekDay,\n    ReferenceDay: localInfoData.qReferenceDay,\n    FirstMonthOfYear: localInfoData.qFirstMonthOfYear,\n    CollationLocale: localInfoData.qCollation,\n    MonthNames: localInfoData.qCalendarStrings.qMonthNames,\n    LongMonthNames: localInfoData.qCalendarStrings.qLongMonthNames,\n    DayNames: localInfoData.qCalendarStrings.qDayNames,\n    LongDayNames: localInfoData.qCalendarStrings.qLongDayNames,\n  };\n}\n"],"names":["createErrorMessage","errorType","qixError","item","type","message","qErrorString","halyardMixin","types","[object Object]","args","config","api","Promise","extend","halyard","that","this","createSessionApp","then","app","setScriptAndReloadWithHalyard","appName","createApp","appId","qAppId","openDoc","result","existingAppName","createIfMissing","catch","error","code","reject","doSaveAfterReload","deferredConnections","getConnections","forEach","connection","qixConnectionObject","getQixConnectionObject","connectionPromise","createConnection","err","push","all","getLocaleInfo","localeInfoResult","setDefaultSetStatements","ThousandSep","localInfoData","qThousandSep","DecimalSep","qDecimalSep","MoneyThousandSep","qMoneyThousandSep","MoneyDecimalSep","qMoneyDecimalSep","MoneyFormat","qMoneyFmt","TimeFormat","qTimeFmt","DateFormat","qDateFmt","TimestampFormat","qTimestampFmt","FirstWeekDay","qFirstWeekDay","ReferenceDay","qReferenceDay","FirstMonthOfYear","qFirstMonthOfYear","CollationLocale","qCollation","MonthNames","qCalendarStrings","qMonthNames","LongMonthNames","qLongMonthNames","DayNames","qDayNames","LongDayNames","qLongDayNames","globalApi","configureReload","setScript","getScript","doReload","getProgress","progressResult","qErrorData","length","checkScriptSyntax","syntaxCheckData","getItemThatGeneratedScriptAt","qTextPos","doSave","exposeGlobalApi","getObjectArgs","handle","id","genericType","customType","delta","session","getObjectApi","module","exports"],"mappings":"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"}